name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate Secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ Error: VPS_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "âŒ Error: VPS_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_PORT }}" ]; then
            echo "âŒ Error: VPS_PORT secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: VPS_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: ğŸ” Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new -p ${VPS_PORT} ${VPS_USER}@${VPS_HOST} << 'ENDSSH'
            set -e
            
            echo "ğŸ”„ Starting deployment..."
            
            # Navigate to application directory
            cd /var/www/zyphextech
            
            # Stash any local changes
            git stash
            
            # Pull latest code
            echo "ğŸ“¦ Pulling latest code..."
            git pull origin main
            
            # Install/update dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --legacy-peer-deps
            
            # Generate Prisma Client
            echo "ğŸ”§ Generating Prisma Client..."
            npx prisma generate
            
            # Run database migrations
            echo "ğŸ—„ï¸  Running database migrations..."
            npx prisma migrate deploy
            
            # Build application
            echo "ğŸ—ï¸  Building application..."
            npm run build
            
            # Restart application with PM2
            echo "ğŸ”„ Restarting application..."
            pm2 restart zyphextech --update-env
            
            # Wait for application to be ready
            sleep 5
            
            # Health check
            echo "ğŸ¥ Running health check..."
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Deployment successful! Application is healthy."
              pm2 save
            else
              echo "âŒ Health check failed! Rolling back..."
              git reset --hard HEAD~1
              npm ci --production=false
              npm run build
              pm2 restart zyphextech
              exit 1
            fi
          ENDSSH

      - name: ğŸ“Š Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Website: https://www.zyphextech.com"
          echo "â° Deployed at: $(date)"

      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs and VPS status."
