# ‚ö° IMMEDIATE ACTION REQUIRED - Fix GitHub Actions Deployment

**Error:** `The ssh-private-key argument is empty`  
**Cause:** GitHub repository secrets not configured  
**Time to Fix:** ~10 minutes

---

## üéØ Quick Fix Steps

### Step 1: SSH to Your VPS (2 minutes)

```powershell
# On your local machine (PowerShell)
ssh root@66.116.199.219
# Password: ZT@DY#machine01
```

### Step 2: Run Setup Script (5 minutes)

```bash
# On VPS - Download and run the AlmaLinux setup script
cd /root
wget https://raw.githubusercontent.com/isumitmalhotra/Zyphex-Tech/main/scripts/vps-setup-almalinux.sh
chmod +x vps-setup-almalinux.sh
./vps-setup-almalinux.sh
```

**What this does:**
- ‚úÖ Installs all required software (Node.js, PostgreSQL, Redis, Nginx, PM2)
- ‚úÖ Creates deploy user with proper permissions
- ‚úÖ Configures firewall
- ‚úÖ Optimizes PostgreSQL for 4GB RAM
- ‚úÖ Sets up monitoring and log rotation
- ‚úÖ Clones your repository

**Duration:** ~10-15 minutes (fully automated)

### Step 3: Generate SSH Key for GitHub (1 minute)

```bash
# After setup completes, switch to deploy user
su - deploy

# Generate SSH key
ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_deploy -N ""

# Add to authorized_keys
cat ~/.ssh/github_deploy.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# Display private key (COPY THIS!)
cat ~/.ssh/github_deploy
```

**Expected Output:**
```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
... (multiple lines) ...
-----END OPENSSH PRIVATE KEY-----
```

**‚ö†Ô∏è COPY THE ENTIRE OUTPUT INCLUDING THE HEADER AND FOOTER!**

### Step 4: Add Secrets to GitHub (2 minutes)

1. **Go to GitHub Secrets:**
   - Visit: https://github.com/isumitmalhotra/Zyphex-Tech/settings/secrets/actions
   - Click "New repository secret"

2. **Add Secret #1: VPS_SSH_PRIVATE_KEY**
   - Name: `VPS_SSH_PRIVATE_KEY`
   - Value: Paste the entire private key from Step 3
   - Click "Add secret"

3. **Add Secret #2: VPS_HOST**
   - Name: `VPS_HOST`
   - Value: `66.116.199.219`
   - Click "Add secret"

4. **Add Secret #3: VPS_USER**
   - Name: `VPS_USER`
   - Value: `deploy`
   - Click "Add secret"

5. **Add Secret #4: VPS_PORT**
   - Name: `VPS_PORT`
   - Value: `22`
   - Click "Add secret"

### Step 5: Configure Environment Variables (3 minutes)

```bash
# Still as deploy user on VPS
cd /var/www/zyphextech

# Create production environment file
nano .env.production
```

**Minimum Required Configuration:**

```bash
# Database (generated by setup script)
DATABASE_URL="postgresql://zyphex:zyphex_secure_pass_2024@localhost:5432/zyphextech"

# Redis (generated by setup script)
REDIS_URL="redis://:zyphex_redis_pass_2024@localhost:6379"

# NextAuth - GENERATE THIS!
NEXTAUTH_URL="https://www.zyphextech.com"
NEXTAUTH_SECRET="YOUR_RANDOM_SECRET_HERE"

# Node
NODE_ENV="production"
PORT=3000

# Email (update with your SMTP provider)
EMAIL_FROM="noreply@zyphextech.com"
SMTP_HOST="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="your-smtp-user"
SMTP_PASSWORD="your-smtp-password"
```

**Generate NEXTAUTH_SECRET:**
```bash
openssl rand -base64 32
```

**Save and set permissions:**
```bash
chmod 600 .env.production
```

### Step 6: Setup Nginx & SSL (2 minutes)

```bash
# Copy Nginx config
sudo cp /var/www/zyphextech/configs/nginx/zyphextech.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/zyphextech.conf /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Get SSL certificate
sudo certbot --nginx -d www.zyphextech.com --email admin@zyphextech.com --agree-tos --non-interactive

# Reload Nginx
sudo systemctl reload nginx
```

### Step 7: Initial Deployment (3 minutes)

```bash
# As deploy user
cd /var/www/zyphextech

# Install dependencies
npm ci

# Generate Prisma Client
npx prisma generate

# Run migrations
npx prisma migrate deploy

# Build application
npm run build

# Start with PM2
pm2 start ecosystem.config.js
pm2 save

# Check status
pm2 status
pm2 logs zyphextech --lines 20
```

### Step 8: Test & Verify (1 minute)

```bash
# Health check
curl http://localhost:3000/api/health

# Check from browser
# Open: https://www.zyphextech.com
```

### Step 9: Trigger GitHub Actions (30 seconds)

```powershell
# On your local machine
# Make a small change to trigger deployment
git commit --allow-empty -m "trigger deployment"
git push origin main
```

**Watch the deployment:**
- Go to: https://github.com/isumitmalhotra/Zyphex-Tech/actions
- Click on the latest workflow run
- Monitor the deployment progress

---

## ‚úÖ Success Criteria

Your deployment is working when:

- [x] GitHub Actions workflow completes without errors
- [x] `pm2 status` shows "online" status
- [x] `https://www.zyphextech.com` loads successfully
- [x] SSL certificate shows as valid (green padlock)
- [x] `/api/health` returns `{"status":"ok"}`

---

## üö® Common Issues & Quick Fixes

### Issue: "Permission denied (publickey)"

**Fix:**
```bash
# On VPS as deploy user
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
cat ~/.ssh/github_deploy.pub >> ~/.ssh/authorized_keys
```

### Issue: "Database connection error"

**Fix:**
```bash
# Check PostgreSQL is running
sudo systemctl status postgresql-15

# Test connection
psql -h localhost -U zyphex -d zyphextech
# Password: zyphex_secure_pass_2024
```

### Issue: "Port 3000 already in use"

**Fix:**
```bash
pm2 stop all
pm2 delete all
pm2 start ecosystem.config.js
```

### Issue: "SSL certificate error"

**Fix:**
```bash
# Check Nginx configuration
sudo nginx -t

# Rerun certbot
sudo certbot --nginx -d www.zyphextech.com --force-renewal
```

---

## üìû Emergency Rollback

If something goes wrong:

```bash
# On VPS
pm2 stop zyphextech
cd /var/www/zyphextech
git reset --hard HEAD~1
npm ci
npm run build
pm2 restart zyphextech
```

---

## üìö Detailed Documentation

After the quick fix, refer to these for detailed information:

- **Complete Guide:** `VPS_SETUP_COMPLETE_GUIDE.md`
- **Quick Start:** `VPS_DEPLOYMENT_QUICKSTART.md`
- **Full Documentation:** `VPS_DEPLOYMENT_GUIDE.md`
- **Architecture Overview:** `VPS_DEPLOYMENT_SUMMARY.md`

---

## ‚è±Ô∏è Time Breakdown

| Task | Time | Status |
|------|------|--------|
| SSH to VPS | 1 min | ‚è≥ |
| Run setup script | 10 min | ‚è≥ |
| Generate SSH key | 1 min | ‚è≥ |
| Add GitHub secrets | 2 min | ‚è≥ |
| Configure environment | 3 min | ‚è≥ |
| Setup Nginx & SSL | 2 min | ‚è≥ |
| Initial deployment | 3 min | ‚è≥ |
| Test & verify | 1 min | ‚è≥ |
| **Total** | **~23 min** | |

---

## üéØ Start Here

**NEXT STEP:** SSH to your VPS and run the setup script!

```bash
ssh root@66.116.199.219
# Then run the commands from Step 2 above
```

**Questions?** Check the troubleshooting section or detailed guides.

---

**Last Updated:** October 8, 2025  
**VPS:** 66.116.199.219 (AlmaLinux)  
**Domain:** www.zyphextech.com
